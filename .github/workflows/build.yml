name: Build and Push n8n Enterprise Docker Image

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'Specific n8n version tag to build (leave empty for latest stable)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  DOCKER_USERNAME: ${{ github.repository_owner || 'davodm' }}
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone n8n repository and determine version
      id: clone-n8n
      run: |
        git clone https://github.com/n8n-io/n8n.git n8n-source
        cd n8n-source
        git fetch --tags
        
        # Get the latest stable release from n8n (non-prerelease)
        releases_json=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases)
        LATEST_STABLE_TAG=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
        echo "Latest stable release on n8n: $LATEST_STABLE_TAG"
        
        # Determine which version to build
        if [ -n "${{ github.event.inputs.n8n_version }}" ]; then
          INPUT_VERSION="${{ github.event.inputs.n8n_version }}"
          # If input doesn't start with 'n8n@', prepend it (n8n uses n8n@x.x.x format)
          if [[ "$INPUT_VERSION" != n8n@* ]]; then
            TARGET_TAG="n8n@${INPUT_VERSION}"
          else
            TARGET_TAG="$INPUT_VERSION"
          fi
          echo "Using manually specified version: $TARGET_TAG"
          IS_LATEST_STABLE="false"
        else
          TARGET_TAG="$LATEST_STABLE_TAG"
          echo "Using latest stable version: $TARGET_TAG"
          IS_LATEST_STABLE="true"
        fi
        
        # Check if we're building the latest stable (for tagging decision)
        if [ "$TARGET_TAG" = "$LATEST_STABLE_TAG" ]; then
          IS_LATEST_STABLE="true"
        fi
        echo "IS_LATEST_STABLE=$IS_LATEST_STABLE" >> $GITHUB_ENV
        
        if [ -n "$TARGET_TAG" ]; then
          git checkout "$TARGET_TAG"
          echo "N8N_VERSION=$TARGET_TAG" >> $GITHUB_ENV
          # Extract clean version number (remove n8n@ prefix for Docker tag)
          CLEAN_VERSION=$(echo "$TARGET_TAG" | sed 's/^n8n@//')
          echo "N8N_DOCKER_TAG=$CLEAN_VERSION" >> $GITHUB_ENV
        else
          echo "N8N_VERSION=dev" >> $GITHUB_ENV
          echo "N8N_DOCKER_TAG=dev" >> $GITHUB_ENV
          echo "IS_LATEST_STABLE=false" >> $GITHUB_ENV
        fi
        
        N8N_COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "Cloned n8n repository successfully"
        echo "Current commit: $N8N_COMMIT_HASH"
        echo "N8N_COMMIT_HASH=$N8N_COMMIT_HASH" >> $GITHUB_ENV
        echo "Docker version tag: $CLEAN_VERSION"
        echo "Is latest stable: $IS_LATEST_STABLE"

    - name: Copy bypass script to n8n repository
      run: |
        if [ -f "bypass.sh" ]; then
          cp bypass.sh n8n-source/
          echo "bypass.sh copied to n8n-source directory"
        else
          echo "⚠️ bypass.sh not found in current repository"
          exit 1
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install pnpm and setup cache
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Cache pnpm store
      uses: actions/cache@v4
      with:
        path: ~/.local/share/pnpm/store
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('n8n-source/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Apply bypass and build n8n
      run: |
        cd n8n-source
        
        # Run bypass script to modify source files before build
        sed -i 's/\r$//' bypass.sh
        chmod +x bypass.sh
        ./bypass.sh --auto
        echo "✅ Bypass script executed successfully"
        
        # build:docker handles: install → build → create compiled folder
        # The dockerize step may fail (we use our own buildx), but compiled folder will be created
        echo "=== Running build:docker ==="
        pnpm run build:docker || echo "Docker step skipped, checking compiled folder..."
        
        # Verify compiled folder exists
        if [ -d "compiled" ]; then
          echo "✅ Compiled folder created successfully"
          ls -la compiled/
        else
          echo "❌ ERROR: compiled folder not found!"
          ls -la
          exit 1
        fi

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Docker build metadata
      run: |
        cd n8n-source
        
        # Determine Dockerfile location
        if [ -f "docker/images/n8n/Dockerfile" ]; then
          DOCKERFILE_PATH="docker/images/n8n/Dockerfile"
        elif [ -f "Dockerfile" ]; then
          DOCKERFILE_PATH="Dockerfile"
        else
          echo "❌ ERROR: Dockerfile not found!"
          find . -name "Dockerfile" -type f
          exit 1
        fi
        echo "DOCKERFILE_PATH=$DOCKERFILE_PATH" >> $GITHUB_ENV
        echo "Found Dockerfile at: $DOCKERFILE_PATH"
        
        # Extract version from package.json
        if [ -f "package.json" ]; then
          N8N_PKG_VERSION=$(grep -o '"version": *"[^"]*"' package.json | head -1 | sed 's/"version": *"\([^"]*\)"/\1/')
          if [ -n "$N8N_PKG_VERSION" ]; then
            echo "N8N_PKG_VERSION=$N8N_PKG_VERSION" >> $GITHUB_ENV
            echo "Found n8n version: $N8N_PKG_VERSION"
          fi
        fi

    - name: Generate Docker tags
      id: docker-tags
      run: |
        REGISTRY="${{ env.REGISTRY }}"
        USERNAME="${{ env.DOCKER_USERNAME }}"
        BASE="${REGISTRY}/${USERNAME}/n8n"
        
        # Always include version tag and commit hash
        TAGS="${BASE}:${{ env.N8N_DOCKER_TAG }}"
        TAGS="${TAGS},${BASE}:${{ env.N8N_COMMIT_HASH }}"
        
        # Only add latest, stable, enterprise if this is the latest stable release
        if [ "${{ env.IS_LATEST_STABLE }}" = "true" ]; then
          TAGS="${TAGS},${BASE}:latest"
          TAGS="${TAGS},${BASE}:stable"
          TAGS="${TAGS},${BASE}:enterprise"
          echo "Adding latest/stable/enterprise tags (building latest stable release)"
        else
          echo "Skipping latest/stable/enterprise tags (building specific version)"
        fi
        
        echo "DOCKER_TAGS=${TAGS}" >> $GITHUB_ENV
        echo "Generated tags: ${TAGS}"

    - name: Build and push multi-platform Docker image
      uses: docker/build-push-action@v6
      with:
        context: ${{ github.workspace }}/n8n-source
        file: ${{ github.workspace }}/n8n-source/${{ env.DOCKERFILE_PATH }}
        platforms: ${{ env.PLATFORMS }}
        push: true
        tags: ${{ env.DOCKER_TAGS }}
        labels: |
          org.opencontainers.image.title=n8n Enterprise
          org.opencontainers.image.description=n8n with enterprise features enabled
          org.opencontainers.image.version=${{ env.N8N_VERSION }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ env.N8N_COMMIT_HASH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: Verify pushed images
      run: |
        echo "=== Verifying multi-platform image ==="
        docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_DOCKER_TAG }}
        echo ""
        echo "✅ Successfully built and pushed multi-platform Docker image"
        echo ""
        echo "Image details:"
        echo "  Registry: ${{ env.REGISTRY }}"
        echo "  Repository: ${{ env.DOCKER_USERNAME }}/n8n"
        echo "  Platforms: ${{ env.PLATFORMS }}"
        echo "  n8n Version: ${{ env.N8N_VERSION }}"
        echo "  n8n Commit: ${{ env.N8N_COMMIT_HASH }}"
        echo "  Is Latest Stable: ${{ env.IS_LATEST_STABLE }}"
        echo ""
        echo "Published tags:"
        echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_DOCKER_TAG }}"
        echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_COMMIT_HASH }}"
        if [ "${{ env.IS_LATEST_STABLE }}" = "true" ]; then
          echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:latest"
          echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:stable"
          echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:enterprise"
        fi

    - name: Clean up
      if: always()
      run: |
        docker buildx prune -f || true
        docker system prune -f || true
