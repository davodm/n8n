name: Build and Push n8n Enterprise Docker Image

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'Specific n8n version tag to build (leave empty for latest stable)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  # Use repository owner as username, fallback to davodm
  DOCKER_USERNAME: ${{ github.repository_owner || 'davodm' }}
  IMAGE_TAG: enterprise
  # Match n8n official platforms: linux/amd64 and linux/arm64
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone n8n repository
      id: clone-n8n
      run: |
        git clone https://github.com/n8n-io/n8n.git n8n-source
        cd n8n-source
        git fetch --tags
        
        # Determine which version to build
        if [ -n "${{ github.event.inputs.n8n_version }}" ]; then
          TARGET_TAG="${{ github.event.inputs.n8n_version }}"
          echo "Using manually specified version: $TARGET_TAG"
        else
          # Get latest stable release (non-prerelease)
          releases_json=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases)
          TARGET_TAG=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
          echo "Using latest stable version: $TARGET_TAG"
        fi
        
        if [ -n "$TARGET_TAG" ]; then
          git checkout "$TARGET_TAG"
          # Store original version for labels
          echo "N8N_VERSION=$TARGET_TAG" >> $GITHUB_ENV
          # Sanitize version for Docker tag (replace @ with - and remove invalid chars)
          DOCKER_TAG_VERSION=$(echo "$TARGET_TAG" | sed 's/@/-/g' | sed 's/[^a-zA-Z0-9._-]//g')
          echo "N8N_DOCKER_TAG=$DOCKER_TAG_VERSION" >> $GITHUB_ENV
        else
          echo "N8N_VERSION=dev" >> $GITHUB_ENV
          echo "N8N_DOCKER_TAG=dev" >> $GITHUB_ENV
        fi
        
        N8N_COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "Cloned n8n repository successfully"
        echo "Current commit: $N8N_COMMIT_HASH"
        echo "N8N_COMMIT_HASH=$N8N_COMMIT_HASH" >> $GITHUB_ENV
        echo "Docker tag version: $DOCKER_TAG_VERSION"

    - name: Copy bypass script to n8n repository
      run: |
        if [ -f "bypass.sh" ]; then
          cp bypass.sh n8n-source/
          echo "bypass.sh copied to n8n-source directory"
        else
          echo "⚠️ bypass.sh not found in current repository"
          exit 1
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install pnpm and setup cache
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Cache pnpm store
      uses: actions/cache@v4
      with:
        path: ~/.local/share/pnpm/store
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('n8n-source/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Apply bypass and build n8n
      run: |
        cd n8n-source
        
        # Run bypass script to modify source files before build
        sed -i 's/\r$//' bypass.sh
        chmod +x bypass.sh
        ./bypass.sh --auto
        echo "✅ Bypass script executed successfully"
        
        # build:docker handles: install → build → create compiled folder
        # The dockerize step may fail (we use our own buildx), but compiled folder will be created
        echo "=== Running build:docker ==="
        pnpm run build:docker || echo "Docker step skipped, checking compiled folder..."
        
        # Verify compiled folder exists
        if [ -d "compiled" ]; then
          echo "✅ Compiled folder created successfully"
          ls -la compiled/
        else
          echo "❌ ERROR: compiled folder not found!"
          ls -la
          exit 1
        fi

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Docker build metadata
      run: |
        cd n8n-source
        
        # Determine Dockerfile location
        if [ -f "docker/images/n8n/Dockerfile" ]; then
          DOCKERFILE_PATH="docker/images/n8n/Dockerfile"
        elif [ -f "Dockerfile" ]; then
          DOCKERFILE_PATH="Dockerfile"
        else
          echo "❌ ERROR: Dockerfile not found!"
          find . -name "Dockerfile" -type f
          exit 1
        fi
        echo "DOCKERFILE_PATH=$DOCKERFILE_PATH" >> $GITHUB_ENV
        echo "Found Dockerfile at: $DOCKERFILE_PATH"
        
        # Extract version from package.json
        if [ -f "package.json" ]; then
          N8N_PKG_VERSION=$(grep -o '"version": *"[^"]*"' package.json | head -1 | sed 's/"version": *"\([^"]*\)"/\1/')
          if [ -n "$N8N_PKG_VERSION" ]; then
            echo "N8N_PKG_VERSION=$N8N_PKG_VERSION" >> $GITHUB_ENV
            echo "Found n8n version: $N8N_PKG_VERSION"
          fi
        fi

    - name: Build and push multi-platform Docker image
      uses: docker/build-push-action@v6
      with:
        context: ${{ github.workspace }}/n8n-source
        file: ${{ github.workspace }}/n8n-source/${{ env.DOCKERFILE_PATH }}
        platforms: ${{ env.PLATFORMS }}
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.IMAGE_TAG }}
          ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:latest
          ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_DOCKER_TAG }}
          ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_COMMIT_HASH }}
        labels: |
          org.opencontainers.image.title=n8n Enterprise
          org.opencontainers.image.description=n8n with enterprise features enabled
          org.opencontainers.image.version=${{ env.N8N_VERSION }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ env.N8N_COMMIT_HASH }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: Verify pushed images
      run: |
        echo "=== Verifying multi-platform image ==="
        docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.IMAGE_TAG }}
        echo ""
        echo "✅ Successfully built and pushed multi-platform Docker image"
        echo ""
        echo "Image details:"
        echo "  Registry: ${{ env.REGISTRY }}"
        echo "  Repository: ${{ env.DOCKER_USERNAME }}/n8n"
        echo "  Platforms: ${{ env.PLATFORMS }}"
        echo "  n8n Version: ${{ env.N8N_VERSION }}"
        echo "  n8n Commit: ${{ env.N8N_COMMIT_HASH }}"
        echo ""
        echo "Available tags:"
        echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.IMAGE_TAG }}"
        echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:latest"
        echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_DOCKER_TAG }}"
        echo "  - ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/n8n:${{ env.N8N_COMMIT_HASH }}"

    - name: Clean up
      if: always()
      run: |
        docker buildx prune -f || true
        docker system prune -f || true
